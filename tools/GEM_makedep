#!/usr/bin/perl

$C="/usr/bin/cpp -I.";
$CFLAGS="-DMAKEDEP"; #"-traditional";

# Flag to emit dependency deps instead of preprocess.
$CDEPFLAGS="-MM";

$deps="";

if (substr($ARGV[0],0,6) eq "-arch=") {
  $arch=substr(shift(@ARGV),6);
  print "Arch is set to: $arch\n";
}

while (substr($ARGV[0],0,1) eq "-") {
  $CFLAGS .= " $ARGV[0]";
  shift @ARGV;
}

open OUT,">rules.mak";

$optimized_objects="OPTIMIZED_OBJECTS = ";

foreach $srcname (@ARGV) {
  printf "Processing $srcname: $C $CDEPFLAGS $CFLAGS $srcname\n";

  $srcname_basename=$srcname;
  $srcname_basename=~s/\.(c|f|f90)$//i;
  $obj = "$srcname_basename.o ";

  # Generate dependencies
  open P, "$C $CDEPFLAGS $CFLAGS $srcname |";
  $deps .= join("",<P>)."\n";
  close P;

  #&nice_append($objects,'$(OBJPREFIX)'.$obj);
}

print OUT "
######################################################
# Autogenerated makefile rules: changes will be lost.
######################################################

$deps
######################################################
";

close F;    


sub nice_append {
  if (length($_[0])-rindex($_[0],"\n")+length($_[1]) > 72) {
    $_[0] .= "\\\n\t";
  }
  $_[0] .= $_[1];
}
