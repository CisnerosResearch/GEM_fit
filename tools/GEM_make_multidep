#!/usr/bin/perl

$C="/usr/bin/cpp -I.";
$CFLAGS="-traditional";

# Flag to emit dependency deps instead of preprocess.
$CDEPFLAGS="-MM $CFLAGS";
$deps="";
if (substr($ARGV[0],0,6) eq "-arch=") {
  $arch=substr(shift(@ARGV),6);
  print "Arch is set to: $arch\n";
}
while (substr($ARGV[0],0,1) eq "-") {
  $CFLAGS .= " $ARGV[0]";
  shift @ARGV;
}
while ($ARGV[0] ne ":") {
  push @targets, shift @ARGV;
  if ($#ARGV<0){
    warn "No : found.";
    exit;
  }
}
shift @ARGV;

open OUT,">rules.mak";

$optimized_objects="OPTIMIZED_OBJECTS = ";

foreach $srcname (@ARGV) {
  printf "Processing %-20s ",$srcname.":";
  undef ($preproc_standard);
  undef ($object_standard);
print "1\n";
  foreach $target (@targets){
    ($target_basename,@exts)=split(/\./,$target);
    $XCFLAGS=join(" -D","",@exts);
    $EXT=join(".","",@exts);
    $srcname_basename=$srcname;
    $srcname_basename=~s/\.(c|f|f90)$//i;
    # Generate pre-processed srcname.
print "Openeing: $C $CFLAGS $XCFLAGS $srcname |\n";
    open P,"$C $CFLAGS $XCFLAGS $srcname |";
    $preproc=join("",<P>);
    close P;
print "done\n";
    if ($preproc ne $preproc_standard){
      print " $target";
      $obj = "$srcname_basename$EXT.o ";
print "1\n";
      # Generate dependency deps
      open P, "$C $CDEPFLAGS $XCFLAGS $srcname -MT '\$(OBJPREFIX)$srcname_basename$EXT.o' |";
      $deps .= join("",<P>)."\n";
      close P;

      if (!defined($object_standard)){ $object_standard=$obj; }
      if ($preproc =~ m/<compile=optimized>/
           and $preproc !~ m/<compile=default>/){
        &nice_append($optimized_objects,'$(OBJPREFIX)'.$obj);
      }
    }
    &nice_append($objects{$target},'$(OBJPREFIX)'.$obj);
    if (!defined($preproc_standard)){ $preproc_standard = $preproc; }
  }
  print "\n";
}

print OUT "
######################################################
# Autogenerated makefile rules: changes will be lost.
######################################################
\n$optimized_objects\n\n";
print "START\n";
foreach $target (@targets){
  ($target_basename,@exts)=split(/\./,$target);
  $objname = join("_","OBJECTS",@exts);
  print "$objname = \\\n\t$objects{$target}\n\n";
  print "$target: \$($objname)\n\t\$(LOAD) \$(LDFLAGS) -o $target \$($objname) \$(LIBS)\n\n";
  print OUT "$objname = \\\n\t$objects{$target}\n\n";
  print OUT "$target: \$($objname)\n\t\$(LOAD) \$(LDFLAGS) -o $target \$($objname) \$(LIBS)\n\n";
}

print OUT "######################################################

$deps

";

close F;    


sub nice_append {
  if (length($_[0])-rindex($_[0],"\n")+length($_[1]) > 72) {
    $_[0] .= "\\\n\t";
  }
  $_[0] .= $_[1];
}
